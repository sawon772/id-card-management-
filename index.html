<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced ID Card Tool with Cloud Save</title>
    <style>
        body { 
            font-family: Arial; 
            text-align: center; 
            margin: 10px; 
            background: #f5f5f5;
        }
        
        #a4canvas { 
            width: 794px; 
            height: 1123px; 
            max-width: 100%;
            border: 1px solid #999; 
            background: white; 
            margin: 10px auto;
        }
        
        .btn, select, input { 
            margin: 5px; 
            padding: 8px 12px; 
            font-size: 14px; 
        }
        
        .preview-img { 
            width: 120px; 
            margin: 5px; 
            border: 1px solid #ccc; 
        }
        
        .card-item { 
            border: 1px solid #ccc; 
            margin: 8px; 
            padding: 8px; 
            background: white; 
            border-radius: 5px; 
        }
        
        /* Mobile Friendly Improvements */
        @media (max-width: 768px) {
            body {
                margin: 5px;
            }
            
            .btn, select, input {
                width: 90%;
                max-width: 200px;
                margin: 4px;
                padding: 10px;
            }
            
            #a4canvas {
                width: 100%;
                height: auto;
            }
            
            .preview-img {
                width: 100px;
            }
        }
        
        .input-group {
            margin: 10px 0;
        }
        
        .button-group {
            margin: 15px 0;
        }
        
        .button-group .btn {
            margin: 4px;
            min-width: 120px;
        }
    </style>
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>ü™™ Advanced Driving License ID Tool</h1>

    <div class="input-group">
        <input type="file" id="file1" accept="image/*">
        <input type="file" id="file2" accept="image/*">
    </div>
    
    <div>
        <img id="preview1" class="preview-img" src="" alt="Front Preview">
        <img id="preview2" class="preview-img" src="" alt="Back Preview">
    </div>

    <div class="input-group">
        <label>Width (mm):</label>
        <input type="number" id="widthMM" value="85" step="0.1">
        
        <label>Height (mm):</label>
        <input type="number" id="heightMM" value="54" step="0.1">
        
        <label>Paper Size:</label>
        <select id="paperSize">
            <option value="A4">A4</option>
            <option value="Letter">Letter</option>
            <option value="Legal">Legal</option>
        </select>
        
        <label>Download as:</label>
        <select id="downloadType">
            <option value="PDF">PDF</option>
            <option value="JPG">JPG</option>
            <option value="PNG">PNG</option>
        </select>
    </div>

    <div class="button-group">
        <button class="btn" onclick="drawCanvas()">Preview & Arrange</button>
        <button class="btn" onclick="downloadOutput()">Download</button>
        <button class="btn" onclick="printCanvas()">Print</button>
        <button class="btn" onclick="shareCanvas()">Share</button>
        <button class="btn" onclick="saveToFirestore()" style="background: #4CAF50; color: white;">Save to Cloud</button>
        <button class="btn" onclick="viewMyCards()" style="background: #2196F3; color: white;">My Saved Cards</button>
    </div>

    <canvas id="a4canvas"></canvas>

    <div id="savedCardsList"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB_jVIj6vnpjRowsysZg79oH3iPFEX40Ow",
            authDomain: "idcardtool.firebaseapp.com",
            projectId: "idcardtool",
            storageBucket: "idcardtool.firebasestorage.app",
            messagingSenderId: "542300187907",
            appId: "1:542300187907:web:227d6f48edc5ca110d0d36",
            measurementId: "G-9XP8EHP686"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Existing Canvas Code - NO CHANGES IN FUNCTIONALITY
        const canvas = document.getElementById("a4canvas");
        const ctx = canvas.getContext("2d");
        let img1 = null;
        let img2 = null;

        // Auto preview on file select
        document.getElementById("file1").addEventListener("change", function(e){
            if(e.target.files[0]){
                const reader = new FileReader();
                reader.onload = () => document.getElementById("preview1").src = reader.result;
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById("file2").addEventListener("change", function(e){
            if(e.target.files[0]){
                const reader = new FileReader();
                reader.onload = () => document.getElementById("preview2").src = reader.result;
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        async function loadImage(file){
            return new Promise(resolve=>{
                const reader = new FileReader();
                reader.onload = ()=>{
                    const img = new Image();
                    img.onload = ()=>resolve(img);
                    img.src = reader.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function drawCanvas(){
            const file1 = document.getElementById("file1").files[0];
            const file2 = document.getElementById("file2").files[0];
            if(!file1 || !file2){
                alert("‡¶¶‡ßÅ‡¶á‡¶ü‡¶ø ‡¶´‡¶æ‡¶á‡¶≤ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®!");
                return;
            }
            img1 = await loadImage(file1);
            img2 = await loadImage(file2);
            
            // Set canvas size based on paper - ORIGINAL CODE
            const paper = document.getElementById("paperSize").value;
            switch(paper){
                case "A4": 
                    canvas.width=794;
                    canvas.height=1123;
                    break;
                case "Letter": 
                    canvas.width=816;
                    canvas.height=1056;
                    break;
                case "Legal": 
                    canvas.width=816;
                    canvas.height=1344;
                    break;
            }
            
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle="white";
            ctx.fillRect(0,0,canvas.width,canvas.height);

            const cardWidth = parseFloat(document.getElementById("widthMM").value)*3.78;
            const cardHeight = parseFloat(document.getElementById("heightMM").value)*3.78;
            const gap = 90;
            const x = (canvas.width - cardWidth)/2;
            const y1 = (canvas.height - (cardHeight*2 + gap))/2;
            const y2 = y1 + cardHeight + gap;

            ctx.drawImage(img1,x,y1,cardWidth,cardHeight);
            ctx.drawImage(img2,x,y2,cardWidth,cardHeight);
            
            alert("‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá ‚úÖ");
        }

        function downloadOutput(){
            const type = document.getElementById("downloadType").value;
            if(type==="PDF"){
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF("p","pt",[canvas.width, canvas.height]);
                pdf.addImage(canvas.toDataURL("image/jpeg"),"JPEG",0,0,canvas.width,canvas.height);
                pdf.save("ID_Arranged.pdf");
            } else {
                const link = document.createElement("a");
                link.download = `ID_Arranged.${type.toLowerCase()}`;
                link.href = canvas.toDataURL(`image/${type.toLowerCase()}`);
                link.click();
            }
        }

        function printCanvas(){
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head><title>Print ID Card</title></head>
                    <body style="text-align: center;">
                        <img src="${canvas.toDataURL('image/png')}" style="max-width: 100%;">
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function shareCanvas(){
            canvas.toBlob(async function(blob){
                const filesArray = [new File([blob], "ID_A4.png", {type: "image/png"})];
                if(navigator.canShare && navigator.canShare({ files: filesArray })){
                    try{
                        await navigator.share({
                            files: filesArray,
                            title: 'ID Card A4',
                            text: 'Here is your arranged ID card!'
                        });
                        alert("Shared successfully ‚úÖ");
                    } catch(err){
                        alert("Share failed: " + err);
                    }
                } else {
                    alert("Your device/browser does not support direct file sharing!");
                }
            });
        }

        // Firebase Functions
        async function saveToFirestore() {
            if (!canvas.width) {
                alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá Preview ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®!");
                return;
            }

            const canvasDataURL = canvas.toDataURL('image/png');
            const cardId = 'card_' + Date.now();
            
            try {
                await db.collection('idcards').doc(cardId).set({
                    canvasImage: canvasDataURL,
                    image1: document.getElementById("preview1").src,
                    image2: document.getElementById("preview2").src,
                    width: document.getElementById("widthMM").value,
                    height: document.getElementById("heightMM").value,
                    paperSize: document.getElementById("paperSize").value,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ID: ${cardId}`);
                
                const shareableLink = `${window.location.origin}${window.location.pathname}?id=${cardId}`;
                alert(`‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï:\n${shareableLink}`);
                
            } catch (error) {
                console.error("Error saving:", error);
                alert("‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            }
        }

        async function viewMyCards() {
            try {
                const snapshot = await db.collection('idcards')
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                const cardsList = document.getElementById('savedCardsList');
                cardsList.innerHTML = '<h3>My Saved Cards:</h3>';
                
                if (snapshot.empty) {
                    cardsList.innerHTML += '<p>No saved cards found.</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card-item';
                    
                    cardElement.innerHTML = `
                        <p><strong>ID:</strong> ${doc.id}</p>
                        <p><strong>Saved:</strong> ${data.createdAt?.toDate().toLocaleString() || 'Unknown'}</p>
                        <p><strong>Size:</strong> ${data.width}mm x ${data.height}mm</p>
                        <button class="btn" onclick="loadCard('${doc.id}')">Load This Card</button>
                        <button class="btn" onclick="shareCard('${doc.id}')">Share</button>
                        <button class="btn" onclick="deleteCard('${doc.id}')" style="background: #f44336; color: white;">Delete</button>
                    `;
                    
                    cardsList.appendChild(cardElement);
                });
                
            } catch (error) {
                console.error("Error loading cards:", error);
                alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            }
        }

        async function loadCard(cardId) {
            try {
                const doc = await db.collection('idcards').doc(cardId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    
                    const img = new Image();
                    img.onload = function() {
                        // Set canvas size based on saved paper size
                        const paper = data.paperSize;
                        switch(paper){
                            case "A4": 
                                canvas.width=794;
                                canvas.height=1123;
                                break;
                            case "Letter": 
                                canvas.width=816;
                                canvas.height=1056;
                                break;
                            case "Legal": 
                                canvas.width=816;
                                canvas.height=1344;
                                break;
                        }
                        
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ");
                    };
                    img.src = data.canvasImage;
                    
                } else {
                    alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
                }
            } catch (error) {
                console.error("Error loading card:", error);
                alert("‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            }
        }

        function shareCard(cardId) {
            const shareableLink = `${window.location.origin}${window.location.pathname}?id=${cardId}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareableLink);
                alert("‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ\n\n" + shareableLink);
            } else {
                alert("‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï:\n" + shareableLink);
            }
        }

        async function deleteCard(cardId) {
            if (confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
                try {
                    await db.collection('idcards').doc(cardId).delete();
                    alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ");
                    viewMyCards();
                } catch (error) {
                    console.error("Error deleting:", error);
                    alert("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                }
            }
        }

        // Load card from URL when page loads
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const cardId = urlParams.get('id');
            
            if (cardId) {
                setTimeout(() => {
                    loadCard(cardId);
                }, 1000);
            }
        };
    </script>
</body>
</html>
