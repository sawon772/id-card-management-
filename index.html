<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced ID Card Tool with Login</title>
    <style>
        body { 
            font-family: Arial; 
            text-align: center; 
            margin: 10px; 
            background: #f5f5f5;
        }
        
        #a4canvas { 
            width: 794px; 
            height: 1123px; 
            max-width: 100%;
            border: 1px solid #999; 
            background: white; 
            margin: 10px auto;
        }
        
        .btn, select, input { 
            margin: 5px; 
            padding: 8px 12px; 
            font-size: 14px; 
        }
        
        .preview-img { 
            width: 120px; 
            margin: 5px; 
            border: 1px solid #ccc; 
        }
        
        .card-item { 
            border: 1px solid #ccc; 
            margin: 8px; 
            padding: 8px; 
            background: white; 
            border-radius: 5px; 
        }

        /* Login Form Styles */
        #loginForm {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 50px auto;
        }
        
        #loginForm input {
            width: 90%;
            margin: 10px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        #loginForm button {
            width: 95%;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        
        .user-info {
            background: #e9f7ef;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            body {
                margin: 5px;
            }
            
            .btn, select, input {
                width: 90%;
                max-width: 200px;
                margin: 4px;
                padding: 10px;
            }
            
            #a4canvas {
                width: 100%;
                height: auto;
            }
            
            .preview-img {
                width: 100px;
            }
            
            #loginForm {
                margin: 20px auto;
                padding: 15px;
            }
        }
    </style>
    <!-- jsPDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
</head>
<body>
    <!-- Login Form -->
    <div id="loginForm">
        <h2>üîê Login to ID Card Tool</h2>
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Password" required>
        <button onclick="login()">Login</button>
        <button onclick="showRegister()" style="background: #28a745;">Register</button>
        <p id="loginMessage"></p>
    </div>

    <!-- Register Form -->
    <div id="registerForm" class="hidden">
        <h2>üìù Register New Account</h2>
        <input type="text" id="registerName" placeholder="Full Name" required>
        <input type="email" id="registerEmail" placeholder="Email" required>
        <input type="password" id="registerPassword" placeholder="Password (min 6 characters)" required>
        <button onclick="register()" style="background: #28a745;">Register</button>
        <button onclick="showLogin()">Back to Login</button>
        <p id="registerMessage"></p>
    </div>

    <!-- Main App (Initially Hidden) -->
    <div id="mainApp" class="hidden">
        <!-- User Info -->
        <div class="user-info">
            Welcome, <span id="userName">User</span>! 
            <button onclick="logout()" style="background: #dc3545; margin-left: 10px;">Logout</button>
        </div>

        <h1>ü™™ Advanced Driving License ID Tool</h1>

        <div>
            <input type="file" id="file1" accept="image/*">
            <input type="file" id="file2" accept="image/*">
        </div>
        
        <div>
            <img id="preview1" class="preview-img" src="" alt="Front Preview">
            <img id="preview2" class="preview-img" src="" alt="Back Preview">
        </div>

        <div>
            <label>Width (mm):</label>
            <input type="number" id="widthMM" value="85" step="0.1">
            
            <label>Height (mm):</label>
            <input type="number" id="heightMM" value="54" step="0.1">
            
            <label>Paper Size:</label>
            <select id="paperSize">
                <option value="A4">A4</option>
                <option value="Letter">Letter</option>
                <option value="Legal">Legal</option>
            </select>
            
            <label>Download as:</label>
            <select id="downloadType">
                <option value="PDF">PDF</option>
                <option value="JPG">JPG</option>
                <option value="PNG">PNG</option>
            </select>
        </div>

        <div>
            <button class="btn" onclick="drawCanvas()">Preview & Arrange</button>
            <button class="btn" onclick="downloadOutput()">Download</button>
            <button class="btn" onclick="printCanvas()">Print</button>
            <button class="btn" onclick="shareCanvas()">Share</button>
            <button class="btn" onclick="saveToFirestore()" style="background: #4CAF50; color: white;">Save to Cloud</button>
            <button class="btn" onclick="viewMyCards()" style="background: #2196F3; color: white;">My Saved Cards</button>
        </div>

        <canvas id="a4canvas"></canvas>

        <div id="savedCardsList"></div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB_jVIj6vnpjRowsysZg79oH3iPFEX40Ow",
            authDomain: "idcardtool.firebaseapp.com",
            projectId: "idcardtool",
            storageBucket: "idcardtool.firebasestorage.app",
            messagingSenderId: "542300187907",
            appId: "1:542300187907:web:227d6f48edc5ca110d0d36",
            measurementId: "G-9XP8EHP686"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Canvas Elements
        const canvas = document.getElementById("a4canvas");
        const ctx = canvas.getContext("2d");
        let img1 = null;
        let img2 = null;

        // UI Elements
        const loginForm = document.getElementById("loginForm");
        const registerForm = document.getElementById("registerForm");
        const mainApp = document.getElementById("mainApp");
        const loginMessage = document.getElementById("loginMessage");
        const registerMessage = document.getElementById("registerMessage");
        const userName = document.getElementById("userName");

        // Authentication Functions
        function showRegister() {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        }

        function showLogin() {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        }

        function register() {
            const name = document.getElementById("registerName").value;
            const email = document.getElementById("registerEmail").value;
            const password = document.getElementById("registerPassword").value;

            if (password.length < 6) {
                registerMessage.textContent = "Password must be at least 6 characters";
                registerMessage.style.color = "red";
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Save user name to Firestore
                    return db.collection('users').doc(userCredential.user.uid).set({
                        name: name,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    registerMessage.textContent = "Registration successful!";
                    registerMessage.style.color = "green";
                    setTimeout(() => {
                        showLogin();
                    }, 2000);
                })
                .catch((error) => {
                    registerMessage.textContent = "Error: " + error.message;
                    registerMessage.style.color = "red";
                });
        }

        function login() {
            const email = document.getElementById("loginEmail").value;
            const password = document.getElementById("loginPassword").value;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Login successful
                    loginMessage.textContent = "Login successful!";
                    loginMessage.style.color = "green";
                    
                    // Get user data
                    return db.collection('users').doc(userCredential.user.uid).get();
                })
                .then((doc) => {
                    if (doc.exists) {
                        userName.textContent = doc.data().name;
                    }
                    showMainApp();
                })
                .catch((error) => {
                    loginMessage.textContent = "Error: " + error.message;
                    loginMessage.style.color = "red";
                });
        }

        function logout() {
            auth.signOut().then(() => {
                showLoginForm();
            });
        }

        function showMainApp() {
            loginForm.classList.add('hidden');
            registerForm.classList.add('hidden');
            mainApp.classList.remove('hidden');
        }

        function showLoginForm() {
            mainApp.classList.add('hidden');
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            
            // Clear forms
            document.getElementById("loginEmail").value = "";
            document.getElementById("loginPassword").value = "";
            document.getElementById("registerName").value = "";
            document.getElementById("registerEmail").value = "";
            document.getElementById("registerPassword").value = "";
            loginMessage.textContent = "";
            registerMessage.textContent = "";
        }

        // Check if user is already logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                db.collection('users').doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        userName.textContent = doc.data().name;
                    }
                    showMainApp();
                });
            } else {
                // User is signed out
                showLoginForm();
            }
        });

        // Existing ID Card Tool Functions
        document.getElementById("file1").addEventListener("change", function(e){
            if(e.target.files[0]){
                const reader = new FileReader();
                reader.onload = () => document.getElementById("preview1").src = reader.result;
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById("file2").addEventListener("change", function(e){
            if(e.target.files[0]){
                const reader = new FileReader();
                reader.onload = () => document.getElementById("preview2").src = reader.result;
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        async function loadImage(file){
            return new Promise(resolve=>{
                const reader = new FileReader();
                reader.onload = ()=>{
                    const img = new Image();
                    img.onload = ()=>resolve(img);
                    img.src = reader.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function drawCanvas(){
            const file1 = document.getElementById("file1").files[0];
            const file2 = document.getElementById("file2").files[0];
            if(!file1 || !file2){
                alert("‡¶¶‡ßÅ‡¶á‡¶ü‡¶ø ‡¶´‡¶æ‡¶á‡¶≤ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶®!");
                return;
            }
            img1 = await loadImage(file1);
            img2 = await loadImage(file2);
            
            const paper = document.getElementById("paperSize").value;
            switch(paper){
                case "A4": 
                    canvas.width=794;
                    canvas.height=1123;
                    break;
                case "Letter": 
                    canvas.width=816;
                    canvas.height=1056;
                    break;
                case "Legal": 
                    canvas.width=816;
                    canvas.height=1344;
                    break;
            }
            
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle="white";
            ctx.fillRect(0,0,canvas.width,canvas.height);

            const cardWidth = parseFloat(document.getElementById("widthMM").value)*3.78;
            const cardHeight = parseFloat(document.getElementById("heightMM").value)*3.78;
            const gap = 90;
            const x = (canvas.width - cardWidth)/2;
            const y1 = (canvas.height - (cardHeight*2 + gap))/2;
            const y2 = y1 + cardHeight + gap;

            ctx.drawImage(img1,x,y1,cardWidth,cardHeight);
            ctx.drawImage(img2,x,y2,cardWidth,cardHeight);
            
            alert("‡¶™‡ßç‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá ‚úÖ");
        }

        function downloadOutput(){
            const type = document.getElementById("downloadType").value;
            if(type==="PDF"){
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF("p","pt",[canvas.width, canvas.height]);
                pdf.addImage(canvas.toDataURL("image/jpeg"),"JPEG",0,0,canvas.width,canvas.height);
                pdf.save("ID_Arranged.pdf");
            } else {
                const link = document.createElement("a");
                link.download = `ID_Arranged.${type.toLowerCase()}`;
                link.href = canvas.toDataURL(`image/${type.toLowerCase()}`);
                link.click();
            }
        }

        function printCanvas(){
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head><title>Print ID Card</title></head>
                    <body style="text-align: center;">
                        <img src="${canvas.toDataURL('image/png')}" style="max-width: 100%;">
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function shareCanvas(){
            canvas.toBlob(async function(blob){
                const filesArray = [new File([blob], "ID_A4.png", {type: "image/png"})];
                if(navigator.canShare && navigator.canShare({ files: filesArray })){
                    try{
                        await navigator.share({
                            files: filesArray,
                            title: 'ID Card A4',
                            text: 'Here is your arranged ID card!'
                        });
                        alert("Shared successfully ‚úÖ");
                    } catch(err){
                        alert("Share failed: " + err);
                    }
                } else {
                    alert("Your device/browser does not support direct file sharing!");
                }
            });
        }

        // Fixed Firebase Functions
        async function saveToFirestore() {
            const user = auth.currentUser;
            if (!user) {
                alert("Please login first!");
                return;
            }

            if (!canvas.width) {
                alert("‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá Preview ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®!");
                return;
            }

            const canvasDataURL = canvas.toDataURL('image/png');
            const cardId = 'card_' + Date.now();
            
            try {
                await db.collection('idcards').doc(cardId).set({
                    canvasImage: canvasDataURL,
                    image1: document.getElementById("preview1").src,
                    image2: document.getElementById("preview2").src,
                    width: document.getElementById("widthMM").value,
                    height: document.getElementById("heightMM").value,
                    paperSize: document.getElementById("paperSize").value,
                    userId: user.uid,
                    userName: userName.textContent,
                    userEmail: user.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                alert(`‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ID: ${cardId}`);
                
                const shareableLink = `${window.location.origin}${window.location.pathname}?id=${cardId}`;
                alert(`‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï:\n${shareableLink}`);
                
            } catch (error) {
                console.error("Error saving:", error);
                alert("‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message);
            }
        }

        // FIXED: ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡ßã‡¶° ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        async function viewMyCards() {
            const user = auth.currentUser;
            if (!user) {
                alert("Please login first!");
                return;
            }

            try {
                console.log("Fetching cards for user:", user.uid);
                
                // ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∏‡¶¨ cards ‡¶®‡¶ø‡ßü‡ßá ‡¶Ü‡¶∏‡¶ø (‡¶ï‡ßã‡¶®‡ßã where clause ‡¶õ‡¶æ‡ßú‡¶æ)
                const snapshot = await db.collection('idcards').get();
                
                const cardsList = document.getElementById('savedCardsList');
                cardsList.innerHTML = '<h3>My Saved Cards:</h3>';
                
                if (snapshot.empty) {
                    cardsList.innerHTML += '<p>No cards found in database.</p>';
                    console.log("No cards in database");
                    return;
                }
                
                let foundCards = 0;
                let totalCards = 0;
                
                snapshot.forEach(doc => {
                    totalCards++;
                    const data = doc.data();
                    
                    // Manual filter - ‡¶∂‡ßÅ‡¶ß‡ßÅ current user-‡¶è‡¶∞ cards show ‡¶ï‡¶∞‡¶¨
                    if (data.userId === user.uid) {
                        foundCards++;
                        const cardElement = document.createElement('div');
                        cardElement.className = 'card-item';
                        
                        cardElement.innerHTML = `
                            <p><strong>ID:</strong> ${doc.id}</p>
                            <p><strong>Saved:</strong> ${data.createdAt?.toDate().toLocaleString() || 'Unknown'}</p>
                            <p><strong>Size:</strong> ${data.width}mm x ${data.height}mm</p>
                            <button class="btn" onclick="loadCard('${doc.id}')">Load This Card</button>
                            <button class="btn" onclick="shareCard('${doc.id}')">Share</button>
                            <button class="btn" onclick="deleteCard('${doc.id}')" style="background: #f44336; color: white;">Delete</button>
                        `;
                        
                        cardsList.appendChild(cardElement);
                    }
                });
                
                console.log(`Total cards in database: ${totalCards}`);
                console.log(`Your cards: ${foundCards}`);
                
                if (foundCards === 0) {
                    cardsList.innerHTML += '<p>No saved cards found for your account.</p>';
                }
                
            } catch (error) {
                console.error("Error loading cards:", error);
                alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message);
            }
        }

        // FIXED: ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡ßã‡¶° ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
        async function loadCard(cardId) {
            try {
                const doc = await db.collection('idcards').doc(cardId).get();
                
                if (doc.exists) {
                    const data = doc.data();
                    console.log("Loading card:", cardId, data);
                    
                    // Canvas ‡¶∏‡¶æ‡¶á‡¶ú ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                    const paper = data.paperSize || "A4";
                    switch(paper){
                        case "A4": 
                            canvas.width = 794;
                            canvas.height = 1123;
                            break;
                        case "Letter": 
                            canvas.width = 816;
                            canvas.height = 1056;
                            break;
                        case "Legal": 
                            canvas.width = 816;
                            canvas.height = 1344;
                            break;
                    }
                    
                    // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ");
                    };
                    
                    img.onerror = function() {
                        alert("‡¶á‡¶Æ‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                    };
                    
                    img.src = data.canvasImage;
                    
                    // Form values ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                    if(data.width) document.getElementById("widthMM").value = data.width;
                    if(data.height) document.getElementById("heightMM").value = data.height;
                    if(data.paperSize) document.getElementById("paperSize").value = data.paperSize;
                    
                } else {
                    alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
                }
            } catch (error) {
                console.error("Error loading card:", error);
                alert("‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message);
            }
        }

        function shareCard(cardId) {
            const shareableLink = `${window.location.origin}${window.location.pathname}?id=${cardId}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareableLink);
                alert("‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ\n\n" + shareableLink);
            } else {
                alert("‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï:\n" + shareableLink);
            }
        }

        async function deleteCard(cardId) {
            if (confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶è‡¶á ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
                try {
                    await db.collection('idcards').doc(cardId).delete();
                    alert("‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‚úÖ");
                    viewMyCards();
                } catch (error) {
                    console.error("Error deleting:", error);
                    alert("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + error.message);
                }
            }
        }

        // Load card from URL when page loads
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const cardId = urlParams.get('id');
            
            if (cardId) {
                // Wait for auth to initialize
                setTimeout(() => {
                    loadCard(cardId);
                }, 2000);
            }
        };
    </script>
</body>
</html>
